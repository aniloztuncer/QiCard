<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QiBot</title>

  <!-- Genesys loader -->
  <script type="text/javascript" charset="utf-8">
    (function (g, e, n, es, ys) {
      g['_genesysJs'] = e;
      g[e] = g[e] || function () {
        (g[e].q = g[e].q || []).push(arguments)
      };
      g[e].t = 1 * new Date();
      g[e].c = es;
      ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
    })(window, 'Genesys', 'https://apps.mypurecloud.de/genesys-bootstrap/genesys.min.js', {
      environment: 'prod-euc1',
      deploymentId: '21d8b1f2-0ff4-4e4b-947b-ed49de2fd36f'
    });
  </script>
</head>

<body>

  <div id="genesys-support-center"></div>

  <script>
    // Function to insert iframe inside Genesys Messenger shadow DOM
function insertYouTubeIframe() {

  // 1. Target the Genesys iframe using its known ID or a highly specific selector
  const messengerFrame = document.getElementById('gcm-messenger-frame'); 
  // If the ID isn't used, try the source attribute:
  // const messengerFrame = document.querySelector("iframe[src*='genesys']"); 
  
  if (!messengerFrame || !messengerFrame.shadowRoot) {
    console.warn("Genesys Messenger iframe or shadowRoot not found.");
    return;
  }

  const shadow = messengerFrame.shadowRoot;

  // 2. Access the nested iframe (where chat content lives)
  // Use a more specific selector if possible, e.g., targeting the source path
  const innerFrame = shadow.querySelector("iframe[src*='messaging']"); 
  if (!innerFrame) {
    console.warn("Inner content iframe not found.");
    return;
  }

  // 3. Attempt to get the inner document (This is the Same-Origin Policy choke point)
  let innerDoc;
  try {
    innerDoc = innerFrame.contentDocument || innerFrame.contentWindow.document;
  } catch (e) {
    console.error("ContentDocument access blocked (SecurityError/Same-Origin Policy). Direct DOM manipulation across frames is prohibited.", e);
    // **If this fails, the current approach is impossible.**
    return; 
  }

  // 4. Find all bot message bubbles and replace content
  const bubbles = innerDoc.querySelectorAll(".cx-message-text, .bubble .text");

  bubbles.forEach(b => {
    const html = b.innerHTML;

    if (b.querySelector('iframe')) return; // Avoid re-embedding

    if (html.includes("youtube.com/embed")) {
      const match = html.match(/embed\/([^?"]+)/);
      if (!match) return;

      const videoId = match[1];

      const iframe = document.createElement("iframe");
      iframe.width = "300";
      iframe.height = "180";
      iframe.src = `https://www.youtube.com/embed/${videoId}`;
      iframe.frameBorder = "0";
      iframe.allowFullscreen = true;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";

      b.innerHTML = "";
      b.appendChild(iframe);
    }
  });
}

// --- Combined Listener ---
// Use the 'Messenger.ready' event as the starting point for all logic
Genesys("subscribe", "Messenger.ready", function () {
  
  // 1. Listen for new messages
  Genesys("subscribe", "MessagingService.messagesReceived", function (response) {
    
    // 2. Wait a moment for the new message to be rendered in the Shadow DOM structure
    setTimeout(insertYouTubeIframe, 150); // Increased delay slightly
    
  });
  
  // **Crucial Addition: Also check on 'Messenger.opened' in case the messenger was already loaded but closed**
  Genesys("subscribe", "Messenger.opened", function () {
    // Also run the check when the widget is opened/re-opened
    setTimeout(insertYouTubeIframe, 150); 
  });
});
  </script>
</body>
</html>
