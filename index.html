<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QiBot</title>

  <!-- Genesys loader -->
  <script type="text/javascript" charset="utf-8">
    (function (g, e, n, es, ys) {
      g['_genesysJs'] = e;
      g[e] = g[e] || function () {
        (g[e].q = g[e].q || []).push(arguments)
      };
      g[e].t = 1 * new Date();
      g[e].c = es;
      ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
    })(window, 'Genesys', 'https://apps.mypurecloud.de/genesys-bootstrap/genesys.min.js', {
      environment: 'prod-euc1',
      deploymentId: '21d8b1f2-0ff4-4e4b-947b-ed49de2fd36f'
    });
  </script>
</head>

<body>

  <div id="genesys-support-center"></div>

  <script>
    // Function to insert iframe inside Genesys Messenger shadow DOM
function insertYouTubeIframe() {

  // 1. Messenger is inside an iframe with an open shadowRoot
  // Use attribute selectors for robustness
  const messengerFrame = document.querySelector("iframe[id*='gcm-messenger-frame']");
  if (!messengerFrame || !messengerFrame.shadowRoot) {
    console.error("Genesys Messenger iframe or shadowRoot not found.");
    return;
  }

  const shadow = messengerFrame.shadowRoot;

  // 2. Genesys message bubbles live inside a nested iframe.
  // This is the common failure point due to Same-Origin Policy.
  // We must try to get the inner document.
  const innerFrame = shadow.querySelector("iframe[src*='messaging']");
  if (!innerFrame) {
    console.warn("Inner iframe not found. Messenger may not be fully loaded.");
    return;
  }

  // Check for Same-Origin Policy block before continuing
  let innerDoc;
  try {
    // This line is often the source of the SecurityError
    innerDoc = innerFrame.contentDocument || innerFrame.contentWindow.document;
  } catch (e) {
    console.error("ContentDocument access denied (Same-Origin Policy likely):", e);
    // If blocked, we cannot proceed with this method.
    return; 
  }

  if (!innerDoc) {
    console.warn("Inner document is not accessible.");
    return;
  }

  // 3. Find all bot message bubbles that contain text (not just attachments/cards)
  // Use a reliable selector for the text content container.
  const bubbles = innerDoc.querySelectorAll(".cx-message-text, .bubble .text");

  bubbles.forEach(b => {
    const html = b.innerHTML;

    // A. Check if the bubble already has an iframe (to prevent double-embedding)
    if (b.querySelector('iframe')) return; 

    // B. Check for the YouTube embed link in the bubble's content
    if (html.includes("youtube.com/embed")) {

      // C. Extract the video ID from the HTML content of THIS SPECIFIC BUBBLE
      const match = html.match(/embed\/([^?"]+)/);
      if (!match) return;

      const videoId = match[1];

      // D. Create the iframe
      const iframe = document.createElement("iframe");
      iframe.width = "300";
      iframe.height = "180";
      iframe.src = `https://www.youtube.com/embed/${videoId}`;
      iframe.frameBorder = "0";
      iframe.allowFullscreen = true;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";

      // E. Replace the content
      b.innerHTML = ""; // Clear the text link
      b.appendChild(iframe); // Insert the video
    }
  });
}

// --- Genesys SDK Listener ---
Genesys("subscribe", "Messenger.ready", function () {
  
  // Listen to ALL incoming messages from Genesys
  Genesys("subscribe", "MessagingService.messagesReceived", function (response) {
    
    // Set a small delay to ensure the DOM has been updated by the Genesys renderer
    setTimeout(() => {
      // Call the function without passing a videoId
      insertYouTubeIframe(); 
    }, 120); 
    
  });
});
  </script>
</body>
</html>
