<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QiBot</title>

  <!-- Genesys loader -->
  <script type="text/javascript" charset="utf-8">
    (function (g, e, n, es, ys) {
      g['_genesysJs'] = e;
      g[e] = g[e] || function () {
        (g[e].q = g[e].q || []).push(arguments)
      };
      g[e].t = 1 * new Date();
      g[e].c = es;
      ys = document.createElement('script'); ys.async = 1; ys.src = n; ys.charset = 'utf-8'; document.head.appendChild(ys);
    })(window, 'Genesys', 'https://apps.mypurecloud.de/genesys-bootstrap/genesys.min.js', {
      environment: 'prod-euc1',
      deploymentId: '21d8b1f2-0ff4-4e4b-947b-ed49de2fd36f'
    });
  </script>
</head>

<body>

  <div id="genesys-support-center"></div>

  <script>
    // Function to extract video ID and replace the link with an iframe
function insertYouTubeIframe() {
  // --- DOM Traversal ---

  // 1. Messenger is inside an iframe with an open shadowRoot
  const messengerFrame = document.querySelector("iframe[src*='genesys']");
  if (!messengerFrame) {
    console.error("Genesys Messenger iframe not found.");
    return;
  }

  // 2. Access the main Shadow Root
  const shadow = messengerFrame.shadowRoot;
  if (!shadow) {
    console.error("Genesys Messenger Shadow DOM not found.");
    return;
  }

  // 3. Genesys message bubbles live inside nested iframe
  const innerFrame = shadow.querySelector("iframe");
  // Check if innerFrame is null and if so, try to get the document directly
  const innerShadow = innerFrame ? 
    (innerFrame.contentDocument || innerFrame.contentWindow.document) : 
    shadow; // Fallback to main shadow if no inner frame

  if (!innerShadow) {
    console.error("Inner Shadow/Document not accessible.");
    return;
  }

  // --- Element Manipulation ---
  
  // Find all bot message bubbles (use one or both selectors based on your Genesys version)
  const bubbles = innerShadow.querySelectorAll(".cx-message-text, .bubble .text");

  bubbles.forEach(b => {
    const html = b.innerHTML;

    // Check if the bubble already contains an iframe (to prevent double-embedding)
    if (b.querySelector('iframe')) return;

    // 1. Check for the YouTube embed link in the bubble's content
    if (html.includes("youtube.com/embed")) {

      // 2. Extract the video ID from the HTML content of THIS SPECIFIC BUBBLE
      const match = html.match(/embed\/([^?"]+)/);
      if (!match) return;

      const videoId = match[1];

      // 3. Create the iframe
      const iframe = document.createElement("iframe");
      iframe.width = "300";
      iframe.height = "180";
      iframe.src = `https://www.youtube.com/embed/${videoId}`;
      iframe.frameBorder = "0";
      iframe.allowFullscreen = true;
      iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"; // Recommended for embeds

      // 4. Clear the bubble content and append the iframe
      b.innerHTML = "";
      b.appendChild(iframe);
    }
  });
}

// --- Original Genesys Listener ---
Genesys("subscribe", "Messenger.ready", function () {
  
  // Listen to ALL incoming messages from Genesys
  // The response.messages now only triggers the rendering process
  Genesys("subscribe", "MessagingService.messagesReceived", function (response) {
    
    // The core logic is now just to wait for Genesys to render the bubble
    // We removed the videoId extraction and passing from here.
    setTimeout(() => {
      // Call the function WITHOUT passing a videoId
      insertYouTubeIframe(); 
    }, 120); // The 120ms timeout is still necessary and a good practice
    
  });
});
  </script>
</body>
</html>
